{% extends "inventory/base.html" %}

{% block title %}Chat Assistant{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-4">
    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card delta-card h-100">
                <div class="card-body">
                    <h1 class="h5 mb-1">Chat Assistant</h1>
                    <p class="text-muted mb-3">
                        English + Arabic assistant for inventory. Writes always require confirmation.
                    </p>

                    <div class="small text-muted mb-3">
                        <div><span class="fw-semibold">Role:</span> {{ assistant_role }}</div>
                        <div><span class="fw-semibold">Branch:</span> {{ assistant_branch.name|default:"-" }}</div>
                    </div>

                    <div class="small">
                        <div class="fw-semibold mb-1">Tools</div>
                        <ul class="mb-0">
                            <li><code>lookup_stock(part_query, branch_scope, include_locations)</code></li>
                            <li><code>add_stock(part_number, branch, location, qty, reason)</code></li>
                            <li><code>remove_stock(part_number, branch, location, qty, reason)</code></li>
                            <li><code>move_stock(part_number, branch, from_location, to_location, qty, reason)</code></li>
                            <li><code>create_transfer_request(part_number, from_branch, to_branch, qty, note)</code></li>
                        </ul>
                    </div>

                    <hr>
                    <div class="small text-muted">
                        <div class="fw-semibold mb-1">Examples</div>
                        <div>- <code>oil</code></div>
                        <div>- <code>show stock oil in مخرج 18 with locations</code></div>
                        <div>- <code>add 5 OIL-1 in الصناعية القديمة A3 reason receive shipment</code></div>
                        <div>- <code>خصم 2 OIL-1 في الصناعية القديمة رف 3 تالف</code></div>
                        <div>- <code>move 1 OIL-1 in الجمعية from A3 to B1</code></div>
                        <div>- <code>transfer 4 OIL-1 from مخرج 18 to الجمعية note urgent demand</code></div>
                    </div>

                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        <input type="hidden" name="clear_chat" value="1">
                        <button type="submit" class="btn btn-sm btn-outline-secondary w-100">Clear Chat</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card delta-card h-100">
                <div class="card-body d-flex flex-column" style="min-height: 70vh;">
                    <h2 class="h6 mb-3">Conversation</h2>

                    <div class="flex-grow-1 overflow-auto border rounded p-3 mb-3 bg-light-subtle" id="chat-scroll">
                        {% for item in chat_history %}
                            <div class="mb-3 d-flex {% if item.role == 'user' %}justify-content-end{% else %}justify-content-start{% endif %}">
                                <div class="px-3 py-2 rounded {% if item.role == 'user' %}bg-primary text-white{% else %}bg-white border{% endif %}" style="max-width: 85%; white-space: pre-line;">
                                    <div class="small fw-semibold mb-1">{% if item.role == 'user' %}You{% else %}Assistant{% endif %}</div>
                                    <div>{{ item.content }}</div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted mb-0">Start by asking about stock.</p>
                        {% endfor %}
                    </div>

                    {% if pending_action %}
                        <div class="alert alert-warning py-2">
                            Pending action: <code>{{ pending_action.action }}</code>. Confirm or cancel.
                        </div>
                        <div class="d-flex gap-2 mb-2">
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="message" value="confirm">
                                <button type="submit" class="btn btn-success btn-sm">Confirm</button>
                            </form>
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="message" value="cancel">
                                <button type="submit" class="btn btn-outline-danger btn-sm">Cancel</button>
                            </form>
                        </div>
                    {% endif %}

                    <form method="post" class="mt-auto">
                        {% csrf_token %}
                        <div class="input-group">
                            <input
                                type="text"
                                name="message"
                                class="form-control"
                                placeholder="Type in English or Arabic..."
                                autocomplete="off"
                                required
                            >
                            <button class="btn btn-primary" type="submit">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    const box = document.getElementById('chat-scroll');
    if (box) {
        box.scrollTop = box.scrollHeight;
    }
})();
</script>
{% endblock %}
