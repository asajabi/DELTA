{% extends 'inventory/base.html' %}

{% block title %}Search Parts{% endblock %}

{% block content %}
<div class="container">
    
    <div class="d-flex justify-content-end mb-3 gap-2">
        <a href="{% url 'cart_view' %}" class="btn btn-primary position-relative">
            üõí View Cart
            <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ cart_total_count }}
            </span>
        </a>
        <a href="{% url 'order_list' %}" class="btn btn-info text-white">üßæ History</a>
        {% if user.is_superuser %}
            <a href="{% url 'low_stock_list' %}" class="btn btn-warning">‚ö†Ô∏è Low Stock</a>
        {% endif %}
        <a href="{% url 'scanner_view' %}" class="btn btn-secondary">üì∑ Scanner</a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">üöó Part Finder</h3>
        </div>
        <div class="card-body text-center py-4">
            {% if request.GET.vehicle %}
                {% for car in vehicles %}
                    {% if car.id|stringformat:"s" == request.GET.vehicle %}
                        <h4 class="text-success mb-3">‚úÖ Selected: {{ car }}</h4>
                    {% endif %}
                {% endfor %}
                <a href="{% url 'vehicle_catalog' %}" class="btn btn-outline-dark">Change Car</a>
                <a href="{% url 'part_search' %}" class="btn btn-danger ms-2">Clear</a>
            {% else %}
                <h5 class="text-muted mb-3">Start by selecting a vehicle</h5>
                <a href="{% url 'vehicle_catalog' %}" class="btn btn-primary btn-lg px-5">üöó Select Car Model</a>
            {% endif %}
        </div>
    </div>

    {% if results %}
    <div class="mt-4">
        <h4>Available Parts</h4>
        <div class="list-group">
            {% for part in results %}
            <div class="list-group-item list-group-item-action shadow-sm mb-2 border-0">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1 text-primary">{{ part.name }}</h5>
                    <small class="text-muted">{{ part.part_number }}</small>
                </div>
                <p class="mb-1 fw-bold fs-5">{{ part.selling_price }} SAR</p>
                <hr class="my-2">
                
                <ul class="list-group list-group-flush">
                    {% for stock in part.stock_set.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                        <span>
                            <i class="fa-solid fa-store text-muted me-2"></i> {{ stock.branch.name }}
                            <span class="badge rounded-pill {% if stock.quantity <= 3 %}bg-danger{% else %}bg-success{% endif %}">
                                {{ stock.quantity }} left
                            </span>
                        </span>
                        
                        {% if stock.quantity > 0 %}
                        <form class="d-flex align-items-center gap-2 add-to-cart-form" data-stock-id="{{ stock.id }}">
                            {% csrf_token %}
                            <input type="number" name="quantity" class="form-control form-control-sm text-center" value="1" min="1" max="{{ stock.quantity }}" style="width: 60px;">
                            <button type="submit" class="btn btn-sm btn-outline-primary">Add</button>
                        </form>
                        {% else %}
                        <button class="btn btn-sm btn-secondary" disabled>No Stock</button>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Copy your existing Add to Cart Javascript here
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            const stockId = this.dataset.stockId;
            const quantity = this.querySelector('input[name="quantity"]').value;
            const csrfToken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const btn = this.querySelector('button');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '‚è≥';
            btn.disabled = true;

            fetch(`/inventory/add-to-cart/${stockId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken },
                body: `quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('cart-badge').innerText = data.total_items;
                    btn.innerHTML = '‚úî';
                    btn.classList.replace('btn-outline-primary', 'btn-success');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        btn.classList.replace('btn-success', 'btn-outline-primary');
                    }, 1000);
                } else {
                    alert(data.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });
    });
</script>
{% endblock %}