<!doctype html>
<html>
  <head>
    <title>Sales Ledger - DELTA</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f4f4f9;
        padding: 20px;
      }
      .summary-box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .summary-title {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .summary-value {
        font-size: 2rem;
        font-weight: bold;
      }
      .profit-pos {
        color: #198754;
      } /* Green */
      .profit-neg {
        color: #dc3545;
      } /* Red */
    </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üìä Accounting Module</h1>
        <a href="{% url 'part_search' %}" class="btn btn-secondary"
          >‚Üê Back to Search</a
        >
      </div>

      <div class="card mb-4 p-3">
        <form method="GET" class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input
              type="date"
              name="start_date"
              class="form-control"
              value="{{ start_date }}"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input
              type="date"
              name="end_date"
              class="form-control"
              value="{{ end_date }}"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Filter by Branch</label>
            <select name="branch" class="form-select">
              <option value="">All Branches</option>
              {% for b in branches %}
              <option
                value="{{ b.branch__id }}"
                {% if current_branch == b.branch__id %}selected{% endif %}
              >
                {{ b.branch__name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1">
              üîç Filter
            </button>

            <button
              type="submit"
              formaction="{% url 'export_sales_csv' %}"
              class="btn btn-success"
            >
              üì• CSV
            </button>
          </div>
        </form>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <div class="summary-box">
            <div class="summary-title">Total Revenue</div>
            <div class="summary-value text-primary">${{ total_revenue }}</div>
          </div>
        </div>

        {% if user.is_superuser %}
        <div class="col-md-6">
          <div class="summary-box">
            <div class="summary-title">Net Profit</div>
            <div
              class="summary-value {% if total_profit >= 0 %}profit-pos{% else %}profit-neg{% endif %}"
            >
              ${{ total_profit }}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="card shadow">
        <div class="card-body">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Part</th>
                <th>Branch</th>
                <th>Seller</th>
                <th>Sold For</th>

                {% if user.is_superuser %}
                <th>Profit</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for sale in sales %}
              <tr>
                <td>{{ sale.date_sold|date:"M d, H:i" }}</td>
                <td>
                  <strong>{{ sale.part.name }}</strong><br />
                  <small class="text-muted">{{ sale.part.part_number }}</small>
                </td>
                <td>{{ sale.branch.name }}</td>
                <td>{{ sale.seller.username }}</td>
                <td>${{ sale.total_revenue }}</td>

                {% if user.is_superuser %}
                <td
                  class="fw-bold {% if sale.total_profit >= 0 %}text-success{% else %}text-danger{% endif %}"
                >
                  ${{ sale.total_profit }}
                </td>
                {% endif %}
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                  No sales found for this period.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
