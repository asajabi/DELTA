{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Invoice #{{ order.order_id }}{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap');

  :root {
    --official-blue: #1a237e;
  }

  /* =========================
     ULTRA-TIGHT PRINT CONFIG
     ========================= */
  @media print {
    @page { size: A4; margin: 0; }

    body, html {
      margin: 0 !important;
      padding: 0 !important;
      height: 100vh;
      background: #fff !important;
      overflow: hidden;
    }

    header, footer, nav, .btn, .no-print, .navbar, .sidebar { 
      display: none !important; 
    }

    .paper-sheet {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      margin: 0 !important;
      padding: 2mm !important; 
      display: flex !important;
      flex-direction: column;
      box-sizing: border-box !important;
    }

    /* Sealed border frame */
    .border-frame {
      flex: 1;
      border: 2pt solid var(--official-blue) !important;
      padding: 5mm !important;
      display: flex !important;
      flex-direction: column;
      box-sizing: border-box !important;
    }
  }

  /* =========================
     SCREEN PREVIEW
     ========================= */
  body { background: #333; font-family: 'Roboto', 'Cairo', sans-serif; }

  .paper-sheet {
    background: #fff;
    width: 210mm;
    height: 297mm;
    margin: 10px auto;
    padding: 2mm;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }

  .border-frame {
    border: 2px solid var(--official-blue);
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 8mm;
    box-sizing: border-box;
  }

  /* Header Branding */
  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--official-blue);
    padding-bottom: 12px;
    margin-bottom: 15px;
  }
  
  /* Adjusted widths to accommodate single-line English name */
  .header-col-en { width: 35%; color: var(--official-blue); }
  .header-col-ar { width: 35%; color: var(--official-blue); text-align: right; }
  
  /* BIGGER LOGO */
  .header-logo { width: 25%; text-align: center; }
  .header-logo img { 
    max-height: 110px; /* Increased from 70px */
    width: auto; 
    display: block;
    margin: 0 auto;
  }

  .brand-en { font-weight: 800; font-size: 17pt; white-space: nowrap; }
  .brand-ar { font-weight: 800; font-size: 17pt; font-family: 'Cairo', sans-serif; white-space: nowrap; }
  .sub-info { font-size: 8.5pt; color: #222; font-weight: 600; margin-top: 2px; }

  .meta-bar {
    background: #f1f3f5;
    border: 1px solid #ccc;
    border-left: 10px solid var(--official-blue);
    padding: 10px 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    font-size: 10.5pt;
  }

  /* Table */
  .table-container { flex: 1; }
  .inv-table { width: 100%; border-collapse: collapse; }
  .inv-table th {
    background: var(--official-blue) !important;
    color: #fff !important;
    -webkit-print-color-adjust: exact;
    padding: 8px;
    font-size: 9pt;
    text-align: left;
  }
  .inv-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #eee;
    font-size: 10.5pt;
  }

  /* Totals & Signatures */
  .footer-section { margin-top: auto; }
  .totals-grid {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 35px;
    padding-top: 10px;
  }
  .totals-table { width: 35%; }
  .totals-table td { padding: 4px 0; font-size: 11pt; }
  .grand-total {
    font-size: 15pt;
    font-weight: 900;
    color: var(--official-blue);
    border-top: 2px solid var(--official-blue);
    padding-top: 5px !important;
  }

  .signatures { display: flex; justify-content: space-between; margin-bottom: 20px; }
  .sig-box { 
    width: 38%; 
    border-top: 1.5px solid #000; 
    text-align: center; 
    padding-top: 6px;
    font-size: 10pt;
    font-weight: bold;
  }

  .bottom-address {
    text-align: center;
    font-size: 8.5pt;
    border-top: 1px solid #ddd;
    padding-top: 10px;
    color: var(--official-blue);
    font-weight: bold;
    line-height: 1.4;
  }
</style>

<div class="paper-sheet">
  <div class="border-frame">
    <div class="header-section">
      <div class="header-col-en">
        <div class="brand-en">DELTA AL-BATT'HA TRAD. CO.</div>
        <div class="sub-info">Auto Spare Parts & Tools</div>
        <div class="sub-info">C.R.: 1010264062</div>
      </div>

      <div class="header-logo">
        <img src="{% static 'inventory/images/logo.png' %}" alt="LOGO">
      </div>

      <div class="header-col-ar">
        <div class="brand-ar" dir="rtl">شركة دلتا البطحاء للتجارة</div>
        <div class="sub-info">لقطع غيار السيارات والمعدات</div>
        <div class="sub-info" dir="rtl">س.ت : ١٠١٠٢٦٤٠٦٢</div>
      </div>
    </div>

    <div class="meta-bar">
      <div>
        <strong>Invoice:</strong> #{{ order.order_id }}<br>
        <strong>Date:</strong> {{ order.created_at|date:"d/m/Y h:i A" }}
      </div>
      <div style="text-align:right;">
        <strong>Customer:</strong> 
        {% if order.customer and order.customer.name != "0" %}
          {{ order.customer.name }}
        {% else %}
          Walk-in Client
        {% endif %}
        <br>
        <strong>Phone:</strong>
        {% if order.customer and order.customer.phone_number %}
          {{ order.customer.phone_number }}
        {% else %}
          -
        {% endif %}
        <br>
        {% if order.customer.car_model and order.customer.car_model != "0" %}
          <small>{{ order.customer.car_model }}</small>
        {% endif %}
      </div>
    </div>

    <div class="table-container">
      <table class="inv-table">
        <thead>
          <tr>
            <th style="width:6%; text-align:center;">#</th>
            <th style="width:44%;">Description</th>
            <th style="width:20%; text-align:center;">Part No</th>
            <th style="width:10%; text-align:center;">Qty</th>
            <th style="width:20%; text-align:right;">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for sale in order.items.all %}
          <tr>
            <td style="text-align:center;">{{ forloop.counter }}</td>
            <td><strong>{{ sale.part.name }}</strong></td>
            <td style="text-align:center;">{{ sale.part.part_number }}</td>
            <td style="text-align:center;">{{ sale.quantity }}</td>
            <td style="text-align:right;">{{ sale.total_revenue }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="footer-section">
      <div class="totals-grid">
        <table class="totals-table">
          <tr>
            <td>Subtotal</td>
            <td style="text-align:right;">{{ order.subtotal }}</td>
          </tr>
          {% if order.discount_amount > 0 %}
          <tr style="color:#c62828; font-weight: bold;">
            <td>Discount</td>
            <td style="text-align:right;">-{{ order.discount_amount }}</td>
          </tr>
          {% endif %}
          <tr>
            <td>VAT (15%)</td>
            <td style="text-align:right;">{{ order.vat_amount }}</td>
          </tr>
          <tr class="grand-total">
            <td>TOTAL</td>
            <td style="text-align:right;">{{ order.grand_total }} SAR</td>
          </tr>
        </table>
      </div>

      <div class="signatures">
        <div class="sig-box">Received By / المستلم</div>
        <div class="sig-box">
          Salesman: {{ order.seller.username|default:"Admin" }}
          <br>
          Employee ID: {{ order.seller.profile.employee_id|default:"N/A" }}
        </div>
      </div>

      <div class="bottom-address">
        <div>الرياض - الصناعية الأولى - تليفون: ٠١١٤٤٦٨٢٥٤ | Riyadh - 1st. Ind. Area - Tel: 011 4468254</div>
        <div>E-mail: dbpparts@gmail.com</div>
      </div>
    </div>
  </div>
</div>

<div class="text-center no-print mt-3 mb-5">
  <button onclick="window.print()" class="btn btn-primary btn-lg shadow px-5">PRINT / REPRINT</button>
  <a href="{% url 'part_search' %}" class="btn btn-outline-dark btn-lg ms-2">GO BACK</a>
</div>
{% endblock %}
